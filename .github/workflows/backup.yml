name: Islamic App Backup System

on:
  schedule:
    - cron: '0 3 * * *'
  workflow_dispatch:

jobs:
  backup_mission:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Install Tools (Postgres 17)
        run: |
          sudo sh -c 'echo "deb https://apt.postgresql.org/pub/repos/apt $(lsb_release -cs)-pgdg main" > /etc/apt/sources.list.d/pgdg.list'
          wget --quiet -O - https://www.postgresql.org/media/keys/ACCC4CF8.asc | sudo apt-key add -
          sudo apt-get update
          sudo apt-get install -y postgresql-client-17 dnsutils
          curl https://rclone.org/install.sh | sudo bash

      - name: Setup Configuration
        env:
          # Secret ကို Variable အနေနဲ့ လှမ်းခေါ်လိုက်လို့ Quote ပြဿနာရှင်းသွားပါပြီ
          RCLONE_CONF: ${{ secrets.RCLONE_CONFIG }}
        run: |
          mkdir -p ~/.config/rclone
          echo "$RCLONE_CONF" > ~/.config/rclone/rclone.conf
          echo "" >> ~/.config/rclone/rclone.conf
          echo "[supabase_storage]" >> ~/.config/rclone/rclone.conf
          echo "type = s3" >> ~/.config/rclone/rclone.conf
          echo "provider = Other" >> ~/.config/rclone/rclone.conf
          echo "env_auth = false" >> ~/.config/rclone/rclone.conf
          echo "access_key_id = ${{ secrets.SUPABASE_ACCESS_KEY_ID }}" >> ~/.config/rclone/rclone.conf
          echo "secret_access_key = ${{ secrets.SUPABASE_SECRET_ACCESS_KEY }}" >> ~/.config/rclone/rclone.conf
          echo "region = ${{ secrets.SUPABASE_STORAGE_REGION }}" >> ~/.config/rclone/rclone.conf
          echo "endpoint = https://${{ secrets.SUPABASE_PROJECT_REF }}.supabase.co/storage/v1/s3" >> ~/.config/rclone/rclone.conf

      - name: Backup Database (Version 17)
        env:
          DB_URL: ${{ secrets.SUPABASE_DB_URL }}
        run: |
          echo "Backing up Database..."
          /usr/lib/postgresql/17/bin/pg_dump "$DB_URL" > db_backup.sql
          
          echo "Uploading Database to OneDrive..."
          rclone copy db_backup.sql "onedrive:MM OASIS APP/Database/"

      - name: Sync All Buckets
        run: |
          echo "Syncing all buckets..."
          rclone copy supabase_storage:masjid-images "onedrive:MM OASIS APP/Storage/masjid-images/" --progress
          rclone copy supabase_storage:shop-images "onedrive:MM OASIS APP/Storage/shop-images/" --progress
          rclone copy supabase_storage:blog-images "onedrive:MM OASIS APP/Storage/blog-images/" --progress
          rclone copy supabase_storage:images "onedrive:MM OASIS APP/Storage/images/" --progress